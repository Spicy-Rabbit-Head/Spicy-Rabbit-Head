{
  "name": "message",
  "type": "registry:component",
  "description": "常用于全局展示一些轻量级的交互反馈信息，如操作成功、失败等。",
  "files": [
    {
      "target": "components/message/index.ts",
      "content": "import { createApp, createVNode, markRaw, render } from 'vue'\n\nimport { proxyExposed, unrefElement } from '@pocui/hooks'\n\nimport { destroyObject, isClient, isNullish, noop, toNumber } from '@pocui/utils'\n\nimport Component from './message.vue'\n\nimport type { MaybeInstance } from '@pocui/hooks'\n\nimport type { App, MaybeRef } from 'vue'\n\nimport type { Key, MessageConfig, MessageInstance, MessageOptions, MessagePlacement, MessageType } from './symbol'\n\nexport type { MessageConfig, MessageType, MessagePlacement, MessageOptions }\n\ntype FuzzyOptions = string | MessageOptions\ntype ManagerOptions = { duration?: number, placement?: MessagePlacement } & Record<string, unknown>\n\ninterface AipMethod {\n  (options: MessageOptions): () => void,\n\n  (content: string, duration?: number): () => void,\n\n  (options: FuzzyOptions, duration?: number): () => void\n}\n\nconst placementWhiteList: MessagePlacement[] = ['top', 'bottom']\n\nlet count = 1\n\nfunction getKey() {\n  return `message-${count++}`\n}\n\nexport class MessageManager {\n  name: string\n\n  defaults: Record<string, unknown>\n\n  open: AipMethod\n\n  primary: AipMethod\n\n  info: AipMethod\n\n  success: AipMethod\n\n  warning: AipMethod\n\n  error: AipMethod\n\n  private _mountedApp: App<unknown> | null\n\n  private _instance: MessageInstance | null\n\n  private _innerApp: App<unknown> | null\n\n  private _container: HTMLElement | null\n\n  private _wrapper: HTMLElement | SVGElement | null\n\n  private _mountedEl: HTMLElement | null\n\n  constructor(options: ManagerOptions = {}) {\n    options = {\n      ...options,\n      duration: options.duration ? toNumber(options.duration) : 3000\n    }\n\n    this._mountedApp = null\n    this._instance = null\n    this._innerApp = null\n    this._container = null\n    this._wrapper = null\n    this._mountedEl = null\n    this.name = 'Message'\n    this.defaults = {}\n\n    this.config(options)\n\n    this.open = (content: FuzzyOptions, duration?: number) => {\n      return this._open(null, content, duration)\n    }\n\n    this.primary = (content: FuzzyOptions, duration?: number) => {\n      return this._open('primary', content, duration)\n    }\n\n    this.info = (content: FuzzyOptions, duration?: number) => {\n      return this._open('info', content, duration)\n    }\n\n    this.success = (content: FuzzyOptions, duration?: number) => {\n      return this._open('success', content, duration)\n    }\n\n    this.warning = (content: FuzzyOptions, duration?: number) => {\n      return this._open('warning', content, duration)\n    }\n\n    this.error = (content: FuzzyOptions, duration?: number) => {\n      return this._open('error', content, duration)\n    }\n  }\n\n  judge(state: boolean, success: string, error: string, duration?: number): void\n  judge(state: boolean, success: MessageOptions, error: string, duration?: number): void\n  judge(state: boolean, success: string, error: MessageOptions, duration?: number): void\n  judge(state: boolean, success: MessageOptions, error: MessageOptions): void\n  judge(state: boolean, success: string | MessageOptions, error: string | MessageOptions, duration?: number) {\n    if (state) {\n      this.success(success, duration)\n    } else {\n      this.error(error, duration)\n    }\n  }\n\n  close(key: Key) {\n    if (isNullish(key)) {\n      this.clear()\n    } else {\n      this._getInstance()?.remove(key)\n    }\n  }\n\n  config({ placement, ...others }: MessageConfig & MessageOptions) {\n    if (placement) {\n      this._getInstance()?.config({\n        placement: placementWhiteList.includes(placement) ? placement : placementWhiteList[0]\n      })\n    }\n\n    this.defaults = { ...this.defaults, ...others }\n  }\n\n  clone() {\n    const manager = new MessageManager(this.defaults)\n\n    manager._mountedApp = this._mountedApp\n\n    return manager\n  }\n\n  clear() {\n    this._getInstance()?.clear()\n  }\n\n  destroy() {\n    this._mountedEl && this._wrapper?.removeChild(this._mountedEl)\n    this._innerApp?.unmount()\n    this._container && render(null, this._container)\n    destroyObject(this)\n  }\n\n  isDestroyed() {\n    return false\n  }\n\n  install(app: App, options: ManagerOptions & { property?: string } = {}) {\n    const { property, ...others } = options\n\n    this.config(others)\n    this._mountedApp = app\n\n    if (property || !app.config.globalProperties.$message) {\n      app.config.globalProperties[property || '$message'] = this\n    }\n  }\n\n  transferTo(target: MaybeRef<string | MaybeInstance>) {\n    if (!isClient) return\n\n    const el = unrefElement(target)\n\n    if (el) {\n      this._wrapper = el as HTMLElement | SVGElement | null\n\n      if (this._instance) {\n        this._mountedEl && !isNullish(this._wrapper) && this._wrapper.appendChild(this._mountedEl)\n      } else {\n        this._getInstance()\n      }\n    }\n  }\n\n  private _getInstance() {\n    if (!this._instance && isClient) {\n      if (!this._mountedApp) {\n        console.warn('[pocui:Message]: 应用程序缺失,插件可能未安装.')\n\n        this._container = document.createElement('div')\n        this._innerApp = createApp(Component)\n        this._instance = this._innerApp.mount(this._container) as MessageInstance\n      } else {\n        const vnode = createVNode(Component, null, null)\n\n        this._container = document.createElement('div')\n        vnode.appContext = this._mountedApp._context\n\n        render(vnode, this._container)\n\n        this._instance = proxyExposed<MessageInstance>(vnode)\n      }\n\n      this._mountedEl = this._container.firstElementChild as HTMLElement\n      ;(this._wrapper || document.body).appendChild(this._mountedEl)\n    }\n\n    return this._instance\n  }\n\n  private _open(type: null | MessageType, content: FuzzyOptions, _duration?: number) {\n    if (!isClient) {\n      return noop\n    }\n\n    const options =\n      typeof content === 'string'\n        ? {\n            content,\n            duration: _duration\n          }\n        : content\n\n    const key = options.key ?? getKey()\n    const message = this._getInstance()!\n\n    let timer: ReturnType<typeof setTimeout>\n\n    const userCloseFn = options.onClose\n    const onClose = () => {\n      clearTimeout(timer)\n\n      if (typeof userCloseFn === 'function') {\n        return userCloseFn()\n      }\n    }\n\n    const userEnterFn = options.onEnter\n    const onEnter = () => {\n      if (options.liveOnEnter) {\n        clearTimeout(timer)\n      }\n\n      if (typeof userEnterFn === 'function') {\n        return userEnterFn()\n      }\n    }\n\n    const userLeaveFn = options.onLeave\n    const onLeave = () => {\n      if (options.liveOnEnter) {\n        clearTimeout(timer)\n        setDelayClose()\n      }\n\n      if (typeof userLeaveFn === 'function') {\n        return userLeaveFn()\n      }\n    }\n\n    const item: MessageOptions = {\n      ...this.defaults,\n      ...options,\n      key,\n      type,\n      onClose,\n      onEnter,\n      onLeave\n    }\n\n    if (item.icon && typeof item.icon !== 'function' && typeof item.icon !== 'string') {\n      item.icon = markRaw(item.icon)\n    }\n\n    message.add(item)\n    setDelayClose()\n\n    function setDelayClose() {\n      const duration = typeof item.duration === 'number' ? item.duration : 3000\n\n      if (duration >= 500) {\n        timer = setTimeout(() => {\n          message.remove(key)\n        }, duration)\n      }\n    }\n\n    return () => {\n      clearTimeout(timer)\n      message.remove(key)\n    }\n  }\n}\n\nexport const Message = new MessageManager()\n"
    },
    {
      "target": "components/message/message.vue",
      "content": "<script setup lang=\"ts\">\nimport { Icon } from '@/components/icon'\nimport { Popup } from '@/components/popup'\nimport { Renderer } from '@/components/renderer'\n\nimport { computed, reactive, ref } from 'vue'\n\nimport { useIcons, useNameHelper } from '@pocui/config'\n\nimport { assertiveTypes, effectiveTypes } from './symbol'\n\nimport type { Key, MessageConfig, MessagePlacement } from './symbol'\n\ndefineOptions({\n  name: 'Message',\n  description:'常用于全局展示一些轻量级的交互反馈信息，如操作成功、失败等。',\n  categories: ['feedback']\n})\n\nconst nh = useNameHelper('message')\nconst icons = useIcons()\n\nconst predefinedIcons = computed(() => ({\n  primary: icons.value.info,\n  info: icons.value.info,\n  success: icons.value.success,\n  warning: icons.value.warning,\n  error: icons.value.error\n}))\n\nconst placement = ref<MessagePlacement>('top')\nconst popup = ref<InstanceType<typeof Popup>>()\n\nconst placementCenter = computed(() => `${placement.value}-center` as const)\n\nasync function add(options: Record<string, any>) {\n  if (popup.value) {\n    await popup.value.add(options)\n  }\n}\n\nasync function remove(key: Key) {\n  return !!popup.value && (await popup.value.remove(key))\n}\n\nfunction config(config: MessageConfig) {\n  placement.value = config.placement || placement.value\n}\n\nfunction clear() {\n  popup.value && popup.value.clear()\n}\n\ndefineExpose(\n  reactive({\n    popup,\n    add,\n    remove,\n    clear,\n    config\n  })\n)\n</script>\n\n<template>\n  <Popup\n    ref=\"popup\"\n    :class=\"nh.b()\"\n    :transition-name=\"nh.ns(`popup-${placement}`)\"\n    :placement=\"placementCenter\"\n  >\n    <template #item=\"item: any\">\n      <div\n        :class=\"[\n          {\n            [nh.be('item')]: true,\n            [nh.bs('vars')]: true,\n            [nh.bem('item', item.type!)]: item.type && effectiveTypes.includes(item.type),\n            [nh.bem('item', 'background')]: item.background,\n            [nh.bem('item', 'color')]: item.background && item.color,\n            [nh.bem('item', 'color-only')]: !item.background && item.color,\n            [nh.bem('item', 'has-icon')]: item.icon,\n            [nh.bem('item', 'closable')]: item.closable\n          },\n          item.className\n        ]\"\n        role=\"alert\"\n        :style=\"[\n          {\n            color: typeof item.color === 'string' ? item.color : undefined,\n            backgroundColor: typeof item.background === 'string' ? item.background : undefined\n          },\n          item.style || {}\n        ]\"\n        aria-atomic=\"true\"\n        :aria-live=\"item.type && assertiveTypes.includes(item.type) ? 'assertive' : 'polite'\"\n      >\n        <div :class=\"nh.be('wrapper')\">\n          <div\n            v-if=\"item.icon || (item.type && effectiveTypes.includes(item.type))\"\n            :class=\"nh.be('icon')\"\n            :style=\"{ color: item.iconColor }\"\n          >\n            <Icon\n              v-if=\"item.icon\"\n              :icon=\"item.icon\"\n              :style=\"[{ color: item.iconColor }, (item.icon as any).style]\"\n            ></Icon>\n            <Icon v-else v-bind=\"predefinedIcons[item.type!]\" :style=\"{ color: item.iconColor }\"></Icon>\n          </div>\n          <Renderer v-if=\"typeof item.renderer === 'function'\" :renderer=\"item.renderer\" :data=\"item\"></Renderer>\n          <template v-else>\n            <div v-if=\"item.parseHtml\" :class=\"nh.be('content')\" v-html=\"item.content\"></div>\n            <div v-else :class=\"nh.be('content')\">\n              {{ item.content || '' }}\n            </div>\n          </template>\n        </div>\n        <button\n          v-if=\"item.closable\"\n          type=\"button\"\n          :class=\"nh.be('close')\"\n          @click=\"remove(item.key!)\"\n        >\n          <Icon v-bind=\"icons.close\" label=\"close\"></Icon>\n        </button>\n      </div>\n    </template>\n  </Popup>\n</template>\n"
    },
    {
      "target": "components/message/symbol.ts",
      "content": "import type { ComponentPublicInstance } from 'vue'\n\nexport type Key = string | number\nexport type MessageType = 'primary' | 'info' | 'success' | 'warning' | 'error'\nexport type MessagePlacement = 'top' | 'bottom'\n\nexport interface MessageOptions extends Record<string, any> {\n  content?: string,\n\n  key?: Key,\n\n  icon?: Record<string, any> | (() => any) | string,\n\n  iconColor?: string,\n\n  type?: MessageType | null,\n\n  duration?: number,\n\n  className?: string | Record<string, any>,\n\n  style?: string | Record<string, any>,\n\n  zIndex?: number,\n\n  background?: boolean | string,\n\n  color?: boolean | string,\n\n  closable?: boolean,\n\n  parseHtml?: boolean,\n\n  liveOnEnter?: boolean,\n\n  renderer?: () => any\n}\n\nexport interface MessageConfig {\n  placement?: MessagePlacement\n}\n\nexport interface MessageInstance extends ComponentPublicInstance {\n  add: (options: MessageOptions) => void,\n\n  remove: (key: string | number) => void,\n\n  clear: () => void,\n\n  config: (config: MessageConfig) => void\n}\n\nexport const effectiveTypes = Object.freeze(['primary', 'info', 'success', 'warning', 'error'])\n\nexport const assertiveTypes = Object.freeze(['success', 'warning', 'error'])\n"
    }
  ],
  "dependencies": ["vue", "@pocui/hooks", "@pocui/utils", "@pocui/config"],
  "registryDependencies": ["message.scss", "icon", "popup", "renderer"],
  "categories": ["feedback"],
  "meta": { "isReferenceOnly": false }
}
